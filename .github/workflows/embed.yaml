name: embed omoikane

on:
  workflow_dispatch:
  schedule:
    - cron: '0 21 * * *'  # JST 6:00

env:
  SID: ${{ secrets.SID }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
  QDARNT_ID: ${{ secrets.QDARNT_ID }}

jobs:
  build:
    permissions:
      contents: 'write'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          lfs: true

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10.4'
          cache: 'pip' # caching pip dependencies
      - run: pip install -r requirements.txt

      - uses: denoland/setup-deno@v1

      - name: Export from Scrapbox(/omoikane to omoikane.json)
        run: export_from_scrapbox/start.sh

      - name: Embed (omoikane.json to omoikane.pickle)
        run: python make_vecs_from_json/main.py

      - name: Commit cache file
        run: ./commit.sh

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: Upload Release Asset
        id: upload_release_asset 
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }} 
          asset_path: ./path-to-your-binary
          asset_name: name-of-your-binary
          asset_content_type: application/octet-stream



      - name: Upload (omoikane.pickle to Qdrant)
        run: python upload_vecs/main.py

      - name: Generate Report and write (omoikane.json to Scrapbox)
        run: python write_to_scrapbox/main.py


